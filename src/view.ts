import { ItemView, WorkspaceLeaf, MarkdownRenderer, TFile } from 'obsidian';
import { MPConverter } from './converter';
import { CopyManager } from './copyManager';
import type { TemplateManager } from './templateManager';
import { DonateManager } from './donateManager';
import type { SettingsManager } from './settings';
export const VIEW_TYPE_MP = 'mp-preview';

export class MPView extends ItemView {
    private previewEl: HTMLElement;
    private currentFile: TFile | null = null;
    private updateTimer: NodeJS.Timeout | null = null;
    private isPreviewLocked: boolean = false;
    private lockButton: HTMLButtonElement;
    private copyButton: HTMLButtonElement;
    private templateManager: TemplateManager;
    private settingsManager: SettingsManager;
    private customTemplateSelect: HTMLElement;
    private customFontSelect: HTMLElement;
    private fontSizeSelect: HTMLInputElement;

    constructor(
        leaf: WorkspaceLeaf, 
        templateManager: TemplateManager,
        settingsManager: SettingsManager
    ) {
        super(leaf);
        this.templateManager = templateManager;
        this.settingsManager = settingsManager;
    }

    getViewType() {
        return VIEW_TYPE_MP;
    }

    getDisplayText() {
        return 'ÂÖ¨‰ºóÂè∑È¢ÑËßà';
    }

    getIcon() {
       return 'eye';
    }

    // Âú® onOpen ÊñπÊ≥ï‰∏≠Êõ¥Êñ∞Â∫ïÈÉ®ÈîÅÂÆöÊåâÈíÆÁöÑÂàõÂª∫
    async onOpen() {
        const container = this.containerEl.children[1];
        container.empty();
        
        const toolbar = container.createEl('div', { cls: 'mp-toolbar' });
        
        // ÈîÅÂÆöÊåâÈíÆ
        this.lockButton = toolbar.createEl('button', {
            cls: 'mp-lock-button',
            attr: { 'aria-label': 'ÂÖ≥Èó≠ÂÆûÊó∂È¢ÑËßàÁä∂ÊÄÅ' }
        });
        this.lockButton.innerHTML = 'üîì';
        this.lockButton.addEventListener('click', () => this.togglePreviewLock());
    
        // ÂàõÂª∫‰∏≠Èó¥Êéß‰ª∂ÂÆπÂô®
        const controlsGroup = toolbar.createEl('div', { cls: 'mp-controls-group' });
        
        // ÂàõÂª∫Ëá™ÂÆö‰πâ‰∏ãÊãâÈÄâÊã©Âô®
        this.customTemplateSelect = this.createCustomSelect(
            controlsGroup,
            'mp-template-select',
            await this.getTemplateOptions()
        );
        this.customTemplateSelect.id = 'template-select';
        
        // Ê∑ªÂä†Ê®°ÊùøÈÄâÊã©Âô®ÁöÑ change ‰∫ã‰ª∂ÁõëÂê¨
        this.customTemplateSelect.querySelector('.custom-select')?.addEventListener('change', async (e: any) => {
            const value = e.detail.value;
            this.templateManager.setCurrentTemplate(value);
            await this.settingsManager.updateSettings({
                templateId: value
            });
            this.templateManager.applyTemplate(this.previewEl);
        });
    
        this.customFontSelect = this.createCustomSelect(
            controlsGroup,
            'mp-font-select',
            this.getFontOptions()
        );

        // Ê∑ªÂä†Â≠ó‰ΩìÈÄâÊã©Âô®ÁöÑ change ‰∫ã‰ª∂ÁõëÂê¨
        this.customFontSelect.querySelector('.custom-select')?.addEventListener('change', async (e: any) => {
            const value = e.detail.value;
            this.templateManager.setFont(value);
            await this.settingsManager.updateSettings({
                fontFamily: value
            });
            this.templateManager.applyTemplate(this.previewEl);
        });
        this.customFontSelect.id = 'font-select';
        // Â≠óÂè∑Ë∞ÉÊï¥
        const fontSizeGroup = controlsGroup.createEl('div', { cls: 'mp-font-size-group' });
        const decreaseButton = fontSizeGroup.createEl('button', { 
            cls: 'mp-font-size-btn',
            text: '-'
        });
        this.fontSizeSelect = fontSizeGroup.createEl('input', { 
            cls: 'mp-font-size-input',
            type: 'text',
            value: '16',
            attr: {
                style: 'border: none; outline: none; background: transparent;'
            }
        });
        const increaseButton = fontSizeGroup.createEl('button', { 
            cls: 'mp-font-size-btn',
            text: '+'
        });

        // ‰ªéËÆæÁΩÆ‰∏≠ÊÅ¢Â§ç‰∏äÊ¨°ÁöÑÈÄâÊã©
        const settings = this.settingsManager.getSettings();
        
        // ÊÅ¢Â§çËÆæÁΩÆ
        if (settings.templateId) {
            const templateSelect = this.customTemplateSelect.querySelector('.selected-text');
            const templateDropdown = this.customTemplateSelect.querySelector('.select-dropdown');
            if (templateSelect && templateDropdown) {
                const option = await this.getTemplateOptions();
                const selected = option.find(o => o.value === settings.templateId);
                if (selected) {
                    // Êõ¥Êñ∞ÈÄâ‰∏≠ÊñáÊú¨ÂíåÂÄº
                    templateSelect.textContent = selected.label;
                    this.customTemplateSelect.querySelector('.custom-select')?.setAttribute('data-value', selected.value);
                    // Êõ¥Êñ∞‰∏ãÊãâÂàóË°®‰∏≠ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                    templateDropdown.querySelectorAll('.select-item').forEach(el => {
                        if (el.getAttribute('data-value') === selected.value) {
                            el.classList.add('selected');
                        } else {
                            el.classList.remove('selected');
                        }
                    });
                }
            }
            this.templateManager.setCurrentTemplate(settings.templateId);
        }

        if (settings.fontFamily) {
            const fontSelect = this.customFontSelect.querySelector('.selected-text');
            const fontDropdown = this.customFontSelect.querySelector('.select-dropdown');
            if (fontSelect && fontDropdown) {
                const option = this.getFontOptions();
                const selected = option.find(o => o.value === settings.fontFamily);
                if (selected) {
                    // Êõ¥Êñ∞ÈÄâ‰∏≠ÊñáÊú¨ÂíåÂÄº
                    fontSelect.textContent = selected.label;
                    this.customFontSelect.querySelector('.custom-select')?.setAttribute('data-value', selected.value);
                    // Êõ¥Êñ∞‰∏ãÊãâÂàóË°®‰∏≠ÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                    fontDropdown.querySelectorAll('.select-item').forEach(el => {
                        if (el.getAttribute('data-value') === selected.value) {
                            el.classList.add('selected');
                        } else {
                            el.classList.remove('selected');
                        }
                    });
                }
            }
            this.templateManager.setFont(settings.fontFamily);
        }

        if (settings.fontSize) {
            this.fontSizeSelect.value = settings.fontSize.toString();
            this.templateManager.setFontSize(settings.fontSize);
        }

        // Êõ¥Êñ∞Â≠óÂè∑Ë∞ÉÊï¥‰∫ã‰ª∂
        const updateFontSize = async () => {
            const size = parseInt(this.fontSizeSelect.value);
            this.templateManager.setFontSize(size);
            await this.settingsManager.updateSettings({
                fontSize: size
            });
            this.templateManager.applyTemplate(this.previewEl);
        };

        // Â≠óÂè∑Ë∞ÉÊï¥ÊåâÈíÆ‰∫ã‰ª∂
        decreaseButton.addEventListener('click', () => {
            const currentSize = parseInt(this.fontSizeSelect.value);
            if (currentSize > 12) {
                this.fontSizeSelect.value = (currentSize - 1).toString();
                updateFontSize();
            }
        });

        increaseButton.addEventListener('click', () => {
            const currentSize = parseInt(this.fontSizeSelect.value);
            if (currentSize < 30) {
                this.fontSizeSelect.value = (currentSize + 1).toString();
                updateFontSize();
            }
        });

        this.fontSizeSelect.addEventListener('change', updateFontSize);

        // È¢ÑËßàÂå∫Âüü
        this.previewEl = container.createEl('div', { cls: 'mp-preview-area' });

        // Â∫ïÈÉ®Â∑•ÂÖ∑Ê†è
        const bottomBar = container.createEl('div', { cls: 'mp-bottom-bar' });

        // Ê∑ªÂä†‰ΩøÁî®ËØ¥ÊòéÊåâÈíÆ
        const helpButton = bottomBar.createEl('button', {
            cls: 'mp-help-button',
            attr: { 'aria-label': '‰ΩøÁî®ÊåáÂçó' }
        });
        helpButton.innerHTML = '‚ùì';
        
        // ÂàõÂª∫ÊèêÁ§∫Ê°Ü
        const tooltip = bottomBar.createEl('div', {
            cls: 'mp-help-tooltip',
            text: `‰ΩøÁî®ÊåáÂçóÔºö
                1. ÈÄâÊã©ÂñúÊ¨¢ÁöÑ‰∏ªÈ¢òÊ®°Êùø
                2. Ë∞ÉÊï¥Â≠ó‰ΩìÂíåÂ≠óÂè∑
                3. ÂÆûÊó∂È¢ÑËßàÊïàÊûú
                4. ÁÇπÂáª„ÄêÂ§çÂà∂ÊåâÈíÆ„ÄëÂç≥ÂèØÁ≤òË¥¥Âà∞ÂÖ¨‰ºóÂè∑
                5. ÁºñËæëÂÆûÊó∂Êü•ÁúãÊïàÊûúÔºåÁÇπüîìÂÖ≥Èó≠ÂÆûÊó∂Âà∑Êñ∞
                6. Â¶ÇÊûú‰Ω†ÂñúÊ¨¢Ëøô‰∏™Êèí‰ª∂ÔºåÊ¨¢ËøéÂÖ≥Ê≥®ÊâìËµè`
        });
        // ÂàõÂª∫‰∏≠Èó¥Êéß‰ª∂ÂÆπÂô®
        const bottomControlsGroup = bottomBar.createEl('div', { cls: 'mp-bottom-controls-group' });
        
        // ËØ∑‰ΩúËÄÖÂñùÂíñÂï°ÊåâÈíÆ
        const likeButton = bottomControlsGroup.createEl('button', { 
            cls: 'mp-like-button'
        });
        likeButton.innerHTML = '<span style="margin-right: 4px">‚ù§Ô∏è</span>ÂÖ≥‰∫é‰ΩúËÄÖ';
        likeButton.addEventListener('click', () => {
            DonateManager.showDonateModal(this.containerEl);
        });

        // Âú®Êéß‰ª∂ÂÆπÂô®‰∏≠ÂàõÂª∫ÊåâÈíÆ
        this.copyButton = bottomControlsGroup.createEl('button', { 
            text: 'Â§çÂà∂‰∏∫ÂÖ¨‰ºóÂè∑Ê†ºÂºè',
            cls: 'mp-copy-button'
        });

        const newButton = bottomControlsGroup.createEl('button', { 
            text: 'Êï¨ËØ∑ÊúüÂæÖ',
            cls: 'mp-new-button'
        });

        // Ê∑ªÂä†Â§çÂà∂ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
        this.copyButton.addEventListener('click', async () => {
            if (this.previewEl) {
                this.copyButton.disabled = true;
                this.copyButton.setText('Â§çÂà∂‰∏≠...');
                
                try {
                    await CopyManager.copyToClipboard(this.previewEl);
                    this.copyButton.setText('Â§çÂà∂ÊàêÂäü');
                    
                    setTimeout(() => {
                        this.copyButton.disabled = false;
                        this.copyButton.setText('Â§çÂà∂‰∏∫ÂÖ¨‰ºóÂè∑Ê†ºÂºè');
                    }, 2000);
                } catch (error) {
                    this.copyButton.setText('Â§çÂà∂Â§±Ë¥•');
                    setTimeout(() => {
                        this.copyButton.disabled = false;
                        this.copyButton.setText('Â§çÂà∂‰∏∫ÂÖ¨‰ºóÂè∑Ê†ºÂºè');
                    }, 2000);
                }
            }
        });

        // ÁõëÂê¨ÊñáÊ°£ÂèòÂåñ
        this.registerEvent(
            this.app.workspace.on('file-open', this.onFileOpen.bind(this))
        );

        // ÁõëÂê¨ÊñáÊ°£ÂÜÖÂÆπÂèòÂåñ
        this.registerEvent(
            this.app.vault.on('modify', this.onFileModify.bind(this))
        );

        // Ê£ÄÊü•ÂΩìÂâçÊâìÂºÄÁöÑÊñá‰ª∂
        const currentFile = this.app.workspace.getActiveFile();
        await this.onFileOpen(currentFile);
    }

    private updateControlsState(enabled: boolean) {
        this.lockButton.disabled = !enabled;
        // Êõ¥Êñ∞Ëá™ÂÆö‰πâÈÄâÊã©Âô®ÁöÑÁ¶ÅÁî®Áä∂ÊÄÅ
        const templateSelect = this.customTemplateSelect.querySelector('.custom-select');
        const fontSelect = this.customFontSelect.querySelector('.custom-select');
        if (templateSelect) {
            templateSelect.classList.toggle('disabled', !enabled);
            // ‰ΩøÁî®setAttributeÊù•ËÆæÁΩÆstyleÂ±ûÊÄß
            templateSelect.setAttribute('style', `pointer-events: ${enabled ? 'auto' : 'none'}`);
        }
        if (fontSelect) {
            fontSelect.classList.toggle('disabled', !enabled);
            // ‰ΩøÁî®setAttributeÊù•ËÆæÁΩÆstyleÂ±ûÊÄß
            fontSelect.setAttribute('style', `pointer-events: ${enabled ? 'auto' : 'none'}`);
        }
        this.fontSizeSelect.disabled = !enabled;
        this.copyButton.disabled = !enabled;
        
        // Ê∑ªÂä†Â≠óÂè∑Ë∞ÉËäÇÊåâÈíÆÁöÑÁä∂ÊÄÅÊéßÂà∂
        const fontSizeButtons = this.containerEl.querySelectorAll('.mp-font-size-btn');
        fontSizeButtons.forEach(button => {
            (button as HTMLButtonElement).disabled = !enabled;
        });
    }

    async onFileOpen(file: TFile | null) {
        this.currentFile = file;
        if (!file || file.extension !== 'md') {
            this.previewEl.empty();
            this.previewEl.createEl('div', {
                text: 'Âè™ËÉΩÈ¢ÑËßà Markdown ÊñáÊú¨ÊñáÊ°£',
                cls: 'mp-empty-message'
            });
            this.updateControlsState(false);
            return;
        }

        this.updateControlsState(true);
        this.isPreviewLocked = false;
        this.lockButton.innerHTML = 'üîì';
        await this.updatePreview();
    }

    private async togglePreviewLock() {
        this.isPreviewLocked = !this.isPreviewLocked;
        const lockIcon = this.isPreviewLocked ? 'üîí' : 'üîì';
        const lockStatus = this.isPreviewLocked ? 'ÂºÄÂêØÂÆûÊó∂È¢ÑËßàÁä∂ÊÄÅ' : 'ÂÖ≥Èó≠ÂÆûÊó∂È¢ÑËßàÁä∂ÊÄÅ';
        this.lockButton.innerHTML = lockIcon;
        this.lockButton.setAttribute('aria-label', lockStatus);
        
        if (!this.isPreviewLocked) {
            await this.updatePreview();
        }
    }

    async onFileModify(file: TFile) {
        if (file === this.currentFile && !this.isPreviewLocked) {
            if (this.updateTimer) {
                clearTimeout(this.updateTimer);
            }
            
            this.updateTimer = setTimeout(() => {
                this.updatePreview();
            }, 500);
        }
    }

    async updatePreview() {
        if (!this.currentFile) return;

        // ‰øùÂ≠òÂΩìÂâçÊªöÂä®‰ΩçÁΩÆÂíåÂÜÖÂÆπÈ´òÂ∫¶
        const scrollPosition = this.previewEl.scrollTop;
        const prevHeight = this.previewEl.scrollHeight;
        const isAtBottom = (this.previewEl.scrollHeight - this.previewEl.scrollTop) <= (this.previewEl.clientHeight + 100);

        this.previewEl.empty();
        const content = await this.app.vault.read(this.currentFile);
        
        await MarkdownRenderer.renderMarkdown(
            content,
            this.previewEl,
            this.currentFile.path,
            this
        );

        MPConverter.formatContent(this.previewEl);
        this.templateManager.applyTemplate(this.previewEl);

        // Ê†πÊçÆÊªöÂä®‰ΩçÁΩÆÂÜ≥ÂÆöÊòØÂê¶Ëá™Âä®ÊªöÂä®
        if (isAtBottom) {
            // Â¶ÇÊûúÁî®Êà∑Âú®Â∫ïÈÉ®ÈôÑËøëÔºåËá™Âä®ÊªöÂä®Âà∞Â∫ïÈÉ®
            requestAnimationFrame(() => {
                this.previewEl.scrollTop = this.previewEl.scrollHeight;
            });
        } else {
            // Âê¶Âàô‰øùÊåÅÂéüÊù•ÁöÑÊªöÂä®‰ΩçÁΩÆ
            const heightDiff = this.previewEl.scrollHeight - prevHeight;
            this.previewEl.scrollTop = scrollPosition + heightDiff;
        }
    }

    // Ê∑ªÂä†Ëá™ÂÆö‰πâ‰∏ãÊãâÈÄâÊã©Âô®ÂàõÂª∫ÊñπÊ≥ï
    private createCustomSelect(
        parent: HTMLElement,
        className: string,
        options: { value: string; label: string }[]
    ) {
        const container = parent.createEl('div', { cls: 'custom-select-container' });
        const select = container.createEl('div', { cls: 'custom-select' });
        const selectedText = select.createEl('span', { cls: 'selected-text' });
        const arrow = select.createEl('span', { cls: 'select-arrow', text: '‚ñæ' });
        
        const dropdown = container.createEl('div', { cls: 'select-dropdown' });
        
        options.forEach(option => {
            const item = dropdown.createEl('div', {
                cls: 'select-item',
                text: option.label
            });
            
            item.dataset.value = option.value;
            item.addEventListener('click', () => {
                // ÁßªÈô§ÂÖ∂‰ªñÈ°πÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                dropdown.querySelectorAll('.select-item').forEach(el => 
                    el.classList.remove('selected'));
                // Ê∑ªÂä†ÂΩìÂâçÈ°πÁöÑÈÄâ‰∏≠Áä∂ÊÄÅ
                item.classList.add('selected');
                selectedText.textContent = option.label;
                select.dataset.value = option.value;
                dropdown.classList.remove('show');
                select.dispatchEvent(new CustomEvent('change', {
                    detail: { value: option.value }
                }));
            });
        });
        
        // ËÆæÁΩÆÈªòËÆ§ÂÄºÂíåÈÄâ‰∏≠Áä∂ÊÄÅ
        if (options.length > 0) {
            selectedText.textContent = options[0].label;
            select.dataset.value = options[0].value;
            dropdown.querySelector('.select-item')?.classList.add('selected');
        }
        
        // ÁÇπÂáªÊòæÁ§∫/ÈöêËóè‰∏ãÊãâÂàóË°®
        select.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdown.classList.toggle('show');
        });
        
        // ÁÇπÂáªÂÖ∂‰ªñÂú∞ÊñπÂÖ≥Èó≠‰∏ãÊãâÂàóË°®
        document.addEventListener('click', () => {
            dropdown.classList.remove('show');
        });
        
        return container;
    }

    // Ëé∑ÂèñÊ®°ÊùøÈÄâÈ°π
    private async getTemplateOptions() {
        await this.templateManager.loadTemplates();
        const templates = this.templateManager.getAllTemplates();
        
        return templates.length > 0
            ? templates.map(t => ({ value: t.id, label: t.name }))
            : [{ value: 'default', label: 'ÈªòËÆ§Ê®°Êùø' }];
    }

    // Ëé∑ÂèñÂ≠ó‰ΩìÈÄâÈ°π
    private getFontOptions() {
        return [
            { 
                value: 'Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, "PingFang SC", Cambria, Cochin, Georgia, Times, "Times New Roman", serif',
                label: 'ÈªòËÆ§Â≠ó‰Ωì'
            },
            { 
                value: 'SimSun, "ÂÆã‰Ωì", serif',
                label: 'ÂÆã‰Ωì'
            },
            { 
                value: 'SimHei, "Èªë‰Ωì", sans-serif',
                label: 'Èªë‰Ωì'
            },
            { 
                value: 'KaiTi, "Ê•∑‰Ωì", serif',
                label: 'Ê•∑‰Ωì'
            },
            { 
                value: '"Microsoft YaHei", "ÂæÆËΩØÈõÖÈªë", sans-serif',
                label: 'ÈõÖÈªë'
            }
        ];
    }
}